# Correções Aplicadas - 30/01/2026

## Problemas Identificados nos Logs

### 1. Erro de i18n (TypeError: Cannot read property 'split' of undefined)
**Causa**: A função `getLanguage()` em `src/i18n/i18n.ts` tentava chamar `.split()` em `Localization.locale` sem verificar se o valor estava definido.

**Sintoma**: 
```
ERROR Error getting language: [TypeError: Cannot read property 'split' of undefined]
```

**Correção Aplicada**: 
- Adicionada verificação robusta para `Localization.locale` e `Localization.getLocales()`
- Fallback seguro para 'pt' quando o locale não está disponível
- Tratamento de erros melhorado

**Arquivo Modificado**: `src/i18n/i18n.ts`

### 2. AppsFilter Bloqueando Comunicação com PlugPagService
**Causa**: Android 11+ requer que apps declarem explicitamente quais outros apps/serviços eles querem interagir usando `<queries>` no AndroidManifest.xml.

**Sintoma nos Logs**:
```
AppsFilter system_server I interaction: PackageSetting{...com.touchgo.mobile...} -> PackageSetting{...br.com.uol.pagseguro.plugpagservice...} BLOCKED
ActivityManager system_server W Unable to start service Intent { cmp=br.com.uol.pagseguro.plugpagservice/.payment.PlugPagService (has extras) } U=0: not found
```

**Correção Aplicada**:
- Criado plugin Expo `plugins/with-pagseguro-queries.js` que adiciona automaticamente as queries necessárias no AndroidManifest.xml
- Plugin adicionado ao `app.json`
- Queries adicionadas para:
  - `br.com.uol.pagseguro.plugpagservice`
  - `br.com.uol.pagseguro.plugpag.libterminal.appservice`

**Arquivos Modificados**:
- `app.json` (adicionado plugin)
- `plugins/with-pagseguro-queries.js` (novo arquivo)

## Próximos Passos

### 1. Regenerar Projeto Android
Execute o comando para regenerar o projeto Android com as novas configurações:

```bash
npx expo prebuild --clean
```

Isso irá:
- Aplicar o plugin `with-pagseguro-queries.js`
- Adicionar as queries necessárias no AndroidManifest.xml
- Regenerar os arquivos nativos do Android

### 2. Rebuild do App
Após o prebuild, faça um novo build:

```bash
# Para debug
npx expo run:android

# Ou para release (se necessário)
eas build --platform android --profile preview --local
```

### 3. Verificar AndroidManifest.xml
Após o prebuild, verifique se as queries foram adicionadas corretamente:

```bash
# Verificar o conteúdo do AndroidManifest.xml gerado
cat android/app/src/main/AndroidManifest.xml | grep -A 10 queries
```

Você deve ver algo como:
```xml
<queries>
    <package android:name="br.com.uol.pagseguro.plugpagservice" />
    <package android:name="br.com.uol.pagseguro.plugpag.libterminal.appservice" />
</queries>
```

### 4. Testar no Dispositivo
1. Instale o app no dispositivo PagSeguro Smart 2
2. Tente fazer um pagamento
3. Verifique os logs com `adb logcat | grep -E "(PagSeguro|PlugPag|AppsFilter)"`

### 5. Se Ainda Houver Problemas

#### Verificar se PlugPagService está instalado:
```bash
adb shell pm list packages | grep pagseguro
```

Você deve ver:
- `br.com.uol.pagseguro.plugpagservice`
- `br.com.uol.pagseguro.plugpag.libterminal.appservice`

#### Verificar permissões do PlugPagService:
```bash
adb shell dumpsys package br.com.uol.pagseguro.plugpagservice | grep -A 5 "exported"
```

#### Logs detalhados:
```bash
adb logcat -s PagSeguroSmart2:D PagSeguroHelper:D ActivityManager:W AppsFilter:I
```

## Notas Importantes

1. **AppsFilter**: Este é um recurso de segurança do Android 11+ que previne apps de descobrirem e interagirem com outros apps sem declaração explícita. As queries resolvem isso.

2. **PlugPagService**: Este é um app separado que deve estar instalado no dispositivo PagSeguro Smart 2. Se não estiver instalado, você precisará instalá-lo separadamente.

3. **i18n**: A correção garante que o app não trave mesmo em ambientes onde o locale não está disponível (como alguns dispositivos POS).

## Referências

- [Android Package Visibility](https://developer.android.com/training/package-visibility)
- [Expo Config Plugins](https://docs.expo.dev/config-plugins/introduction/)
- `docs/PAGSEGURO-SMART2.md` - Documentação da integração PagSeguro
